// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
  EDITOR
  CONTENT_MODERATOR
}

enum LessonStatus {
  DRAFT
  AI_GENERATED
  PUBLISHED
}

enum EducationalLevel {
  COLLEGE_1AC
  COLLEGE_2AC
  COLLEGE_3AC
  LYCEE_TC
  LYCEE_1BAC
  LYCEE_2BAC
  UNIVERSITY
}

enum Stream {
  TC_LETTRES
  TC_SCIENCES
  TC_TECHNOLOGIE
  SC_MATH_A
  SC_MATH_B
  SC_EXPERIMENTAL
  SC_PHYSIQUE
  SC_VIE_TERRE
  SC_ECONOMIE
  LETTRES_HUMAINES
  NONE
}

enum ReportType {
  ERROR
  USER_COMMENT
  CONTACT
  FORUM_COMMENT
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?
  role          UserRole  @default(STUDENT)
  preferredLang String    @default("fr")
  commentSuspendedUntil DateTime?
  isCommentBlocked Boolean @default(false)
  reportSuspendedUntil DateTime?
  isReportBlocked Boolean @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts         Account[]
  sessions         Session[]
  createdLessons   Lesson[]         @relation("LessonCreatedBy")
  createdChapters  Chapter[]        @relation("ChapterCreatedBy")
  createdExams     Exam[]
  forumPosts       ForumPost[]
  forumReplies     ForumReply[]
  forumReactions   ForumReaction[]
  userProgress     UserProgress[]
  uploadedImages   PlatformImage[]  @relation("uploadedImages")
  uploadedVideos   PlatformVideo[]  @relation("uploadedVideos")
  reports          Report[]
  reportReplies    ReportReply[]
  pedagogicalSheets PedagogicalSheet[]
  
  // Classroom Relations
  ownedClassrooms   Classroom[]     @relation("OwnedClassrooms")
  classroomMemberships ClassroomMember[]
  classroomAnnouncements ClassroomAnnouncement[]
  classroomSubmissions   ClassroomSubmission[]
}

model AiContext {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  systemPrompt   String
  structureTemplate String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  lessons Lesson[]
}

model Course {
  id             String   @id @default(cuid())
  name           String
  description    String?
  educationalLevel EducationalLevel
  subject        String
  imageUrl       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  lessons Lesson[]
}

model Lesson {
  id             String   @id @default(cuid())
  titleFr        String
  titleEn        String?
  slug           String   @unique
  contentFr      String?
  contentEn      String?
  level          EducationalLevel
  stream         Stream   @default(NONE)
  semester       Int      @default(1)
  order          Int      @default(1)
  category       String?
  status         LessonStatus @default(DRAFT)
  courseId       String?
  createdById    String?
  aiContextId    String?
  imagesUsed     String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  course         Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  createdBy      User?           @relation("LessonCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: Cascade)
  aiContext      AiContext?      @relation(fields: [aiContextId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  educationalStream EducationalStream? @relation(fields: [educationalStreamId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  module         Module?         @relation(fields: [moduleId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  exercises      Exercise[]
  series         Series[]
  userProgress   UserProgress[]
  chapters       Chapter[]

  educationalStreamId String?
  moduleId            String?

  @@index([level])
  @@index([moduleId])
}

model Exercise {
  id             String   @id @default(cuid())
  slug           String   @unique
  problemTextFr  String
  problemTextEn  String?
  solutionFr     String
  solutionEn     String?
  hints          String[]
  order          Int      @default(0)
  lessonId       String?
  seriesId       String?
  exerciseType   String?  // "QCM" | "FREE_RESPONSE" | null (legacy field, not actively used)
  qcmOptions     String[] @default([]) // For QCM: ["Option A", "Option B", "Option C", "Option D"]
  correctAnswer  String?  // For QCM: "A", "B", "C", "D" or "1", "2", "3", "4" | For free response: the expected answer
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  lesson         Lesson?         @relation(fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  series         Series?         @relation(fields: [seriesId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  userProgress   UserProgress[]

  @@index([lessonId])
}

model Series {
  id             String   @id @default(cuid())
  title          String
  titleEn        String?
  description    String?
  descriptionEn  String?
  slug           String?  @unique
  cycle          String
  level          EducationalLevel
  stream         Stream   @default(NONE)
  semester       Int      @default(1)
  public         Boolean  @default(false)
  lessonId       String?
  educationalStreamId String?
  imagesUsed     String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  lesson         Lesson?         @relation(fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  educationalStream EducationalStream? @relation(fields: [educationalStreamId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  exercises      Exercise[]
}

model EducationalStream {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  level       EducationalLevel
  semesterCount Int    @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lessons     Lesson[]
  series      Series[]
  modules     Module[]
}

model Module {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  educationalStreamId String
  order       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  educationalStream EducationalStream @relation(fields: [educationalStreamId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  lessons           Lesson[]

  @@unique([educationalStreamId, name])
  @@index([educationalStreamId])
}

model Chapter {
  id          String   @id @default(cuid())
  titleFr     String
  titleEn     String?
  slug        String   @unique
  contentFr   String?
  contentEn   String?
  chapterNumber Int    @default(1)
  lessonId    String
  order       Int      @default(1)
  status      LessonStatus @default(DRAFT)
  createdById String?
  imagesUsed  String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  createdBy   User?    @relation("ChapterCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([lessonId])
  @@index([createdById])
}

model ForumPost {
  id             String   @id @default(cuid())
  title          String
  content        String
  userId         String
  isAiAnswered   Boolean  @default(false)
  aiAnswer       String?
  imageUrl       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  replies        ForumReply[]
  reactions      ForumReaction[]

  @@index([userId])
}

model ForumReply {
  id             String   @id @default(cuid())
  content        String
  postId         String
  userId         String
  imageUrl       String?
  isAcceptedAnswer Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  post           ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  reactions      ForumReaction[]
}

model ForumReaction {
  id        String   @id @default(cuid())
  emoji     String
  userId    String
  postId    String?
  replyId   String?
  createdAt DateTime @default(now())

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  post      ForumPost? @relation(fields: [postId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  reply     ForumReply? @relation(fields: [replyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  
  @@unique([userId, postId, emoji])
  @@unique([userId, replyId, emoji])
}

model UserProgress {
  id             String   @id @default(cuid())
  userId         String
  lessonId       String?
  exerciseId     String?
  isCompleted    Boolean  @default(false)
  score          Int?
  completedAt    DateTime @default(now())

  // Relations
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  lesson         Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  exercise       Exercise? @relation(fields: [exerciseId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@unique([userId, lessonId])
  @@unique([userId, exerciseId])
}

model PlatformImage {
  id             String   @id @default(cuid())
  entityType     String
  entityId       String?
  filename       String
  originalFilename String
  filepath       String?  // Made optional - will be null when using base64
  base64Data     String?  @db.Text // Store image as base64 string
  mimeType       String
  fileSize       Int
  uploaderId     String
  metadata       Json?
  createdAt      DateTime @default(now())

  // Relations
  uploader       User     @relation("uploadedImages", fields: [uploaderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model PlatformVideo {
  id             String   @id @default(cuid())
  entityType     String
  entityId       String?
  title          String?
  description    String?
  filename       String
  originalFilename String
  filepath       String?
  url            String?
  mimeType       String
  fileSize       Int
  duration       Float?   // Duration in seconds
  thumbnailUrl   String?
  isPublic       Boolean  @default(true)
  uploaderId     String
  metadata       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  uploader       User     @relation("uploadedVideos", fields: [uploaderId], references: [id], onDelete: Restrict, onUpdate: Cascade)
}

model Exam {
  id             String   @id @default(cuid())
  title          String
  subtitle       String?
  content        Json
  cycle          String
  level          EducationalLevel
  stream         Stream   @default(NONE)
  semester       Int      @default(1)
  type           String
  examType       String?
  controlNumber  Int?
  createdById    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  createdBy      User     @relation(fields: [createdById], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([level])
  @@index([createdById])
}

model Report {
  id          String     @id @default(cuid())
  type        ReportType
  title       String
  description String
  email       String?
  userId      String?
  metadata    Json?
  isResolved  Boolean    @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  user        User?      @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  replies     ReportReply[]
}

model ReportReply {
  id          String     @id @default(cuid())
  reportId    String
  content     String
  repliedById String
  isRead      Boolean   @default(false)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  report      Report     @relation(fields: [reportId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  repliedBy   User       @relation(fields: [repliedById], references: [id], onDelete: Restrict, onUpdate: Cascade)

  @@index([reportId])
  @@index([repliedById])
}

model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PedagogicalSheet {
  id                    String   @id @default(cuid())
  userId                String
  
  // Metadata
  teacherName           String
  schoolName            String
  gradeLevel            EducationalLevel
  stream                String?
  lessonTitle           String?
  duration              String
  pedagogicalGuidelines String?  @db.Text
  prerequisites         String?  @db.Text
  extensions            String?  @db.Text
  didacticTools         String?  @db.Text
  
  // Content
  content               Json     // Array of steps: { type, duration, content, observations }
  
  semester              Int          @default(1)
  status                LessonStatus @default(DRAFT)
  isPublic              Boolean      @default(false)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([userId])
}

// Classroom Models

model Classroom {
  id          String   @id @default(cuid())
  name        String
  description String?
  section     String?
  subject     String?
  room        String?
  code        String   @unique // For joining: "7g5h9k3"
  ownerId     String
  isActive    Boolean  @default(true)
  settings    Json?    // For flexible future settings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner         User                    @relation("OwnedClassrooms", fields: [ownerId], references: [id])
  members       ClassroomMember[]
  announcements ClassroomAnnouncement[]
  assignments   ClassroomAssignment[]
  sessions      ClassroomSession[]
}


model ClassroomMember {
  id          String   @id @default(cuid())
  userId      String
  classroomId String
  role        String   @default("STUDENT") // "TEACHER", "STUDENT"
  joinedAt    DateTime @default(now())
  status      String   @default("ACTIVE")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([userId, classroomId])
}

model ClassroomAnnouncement {
  id          String   @id @default(cuid())
  content     String   @db.Text
  classroomId String
  authorId    String
  attachments Json?    // Array of file URLs/metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

model ClassroomAssignment {
  id          String   @id @default(cuid())
  classroomId String
  title       String
  description String?  @db.Text
  dueDate     DateTime?
  points      Int?     @default(100)
  attachments Json?    // Array of file metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  classroom   Classroom           @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  submissions ClassroomSubmission[]
}

model ClassroomSubmission {
  id           String   @id @default(cuid())
  assignmentId String
  studentId    String
  content      String?  @db.Text
  attachments  Json?    // Submitted files
  grade        Int?
  feedback     String?  @db.Text
  status       String   @default("SUBMITTED") // "DRAFT", "SUBMITTED", "GRADED", "RETURNED"
  submittedAt  DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignment ClassroomAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User                @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
}


model PedagogicalReference {
  id          String   @id @default(cuid())
  title       String
  
  // Categorization (Arrays)
  types       String[] @default([]) // e.g. ["ORIENTATION", "MANUEL", "COURS"]
  levels      EducationalLevel[]
  streams     Stream[]
  semesters   Int[]

  // Scope
  targetsAllLessons Boolean @default(false) // If true, matches purely on tags
  targetLessonIds   String[] // Specific Lesson IDs this reference supports

  subject     String?  @default("MATH")
  fileUrl     String
  textContent String?  @db.Text
  extractedData Json?  // AI extracted Structured Content
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Enhanced Classroom Models for Enterprise Features

model ClassroomSession {
  id              String   @id @default(cuid())
  classroomId     String
  roomName        String   // LiveKit room name
  hostId          String
  title           String?
  description     String?  @db.Text
  scheduledStart  DateTime?
  scheduledEnd    DateTime?
  actualStart     DateTime?
  actualEnd       DateTime?
  status          String   @default("SCHEDULED") // SCHEDULED, LIVE, ENDED, CANCELLED
  recordingUrl    String?
  recordingSize   Int?     // in bytes
  transcriptUrl   String?
  duration        Int?     // in seconds
  maxParticipants Int      @default(100)
  settings        Json?    // Session-specific settings
  metadata        Json?    // Analytics, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  attendances     ClassroomAttendance[]
  chatMessages    ClassroomChatMessage[]
  breakoutRooms   ClassroomBreakoutRoom[]
  polls           ClassroomPoll[]
  recordings      ClassroomRecording[]

  @@index([classroomId])
  @@index([status])
  @@index([scheduledStart])
}

model ClassroomAttendance {
  id          String   @id @default(cuid())
  sessionId   String
  userId      String
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  duration    Int?     // in seconds
  isPresent   Boolean  @default(true)
  deviceInfo  Json?    // Browser, OS, etc.
  ipAddress   String?
  metadata    Json?    // Participation metrics
  createdAt   DateTime @default(now())

  session     ClassroomSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@index([joinedAt])
}

model ClassroomRecording {
  id              String   @id @default(cuid())
  sessionId       String
  title           String
  description     String?  @db.Text
  fileUrl         String
  thumbnailUrl    String?
  duration        Int      // in seconds
  fileSize        Int      // in bytes
  format          String   @default("webm") // webm, mp4, etc.
  quality         String   @default("HD")   // SD, HD, FHD, 4K
  hasTranscript   Boolean  @default(false)
  transcriptUrl   String?
  hasSubtitles    Boolean  @default(false)
  subtitlesUrl    String?
  viewCount       Int      @default(0)
  downloadCount   Int      @default(0)
  isPublic        Boolean  @default(false)
  metadata        Json?    // Chapters, highlights, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  session         ClassroomSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

model ClassroomBreakoutRoom {
  id          String   @id @default(cuid())
  sessionId   String
  name        String
  roomNumber  Int
  capacity    Int      @default(10)
  duration    Int?     // in seconds
  startedAt   DateTime?
  endedAt     DateTime?
  status      String   @default("PENDING") // PENDING, ACTIVE, ENDED
  assignments Json?    // Array of user IDs assigned to this room
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session     ClassroomSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([status])
}

model ClassroomChatMessage {
  id          String   @id @default(cuid())
  sessionId   String
  senderId    String
  senderName  String
  message     String   @db.Text
  messageType String   @default("TEXT") // TEXT, FILE, POLL, ANNOUNCEMENT
  attachments Json?    // File metadata
  replyToId   String?
  isPrivate   Boolean  @default(false)
  recipientId String?  // For private messages
  reactions   Json?    // Array of reactions
  isDeleted   Boolean  @default(false)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session     ClassroomSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([senderId])
  @@index([createdAt])
}

model ClassroomPoll {
  id          String   @id @default(cuid())
  sessionId   String
  creatorId   String
  question    String   @db.Text
  options     Json     // Array of poll options
  pollType    String   @default("MULTIPLE_CHOICE") // MULTIPLE_CHOICE, RATING, WORD_CLOUD
  allowMultiple Boolean @default(false)
  isAnonymous Boolean  @default(false)
  isActive    Boolean  @default(true)
  results     Json?    // Aggregated results
  responses   Json?    // Individual responses
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session     ClassroomSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([isActive])
}

model ClassroomQuiz {
  id          String   @id @default(cuid())
  classroomId String
  title       String
  description String?  @db.Text
  questions   Json     // Array of questions with answers
  duration    Int?     // in seconds
  passingScore Int     @default(70)
  isActive    Boolean  @default(true)
  settings    Json?    // Shuffle, show answers, etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  responses   ClassroomQuizResponse[]

  @@index([classroomId])
}

model ClassroomQuizResponse {
  id          String   @id @default(cuid())
  quizId      String
  studentId   String
  answers     Json     // Array of student answers
  score       Int?
  totalPoints Int?
  isPassed    Boolean  @default(false)
  startedAt   DateTime @default(now())
  submittedAt DateTime?
  duration    Int?     // in seconds
  metadata    Json?

  quiz        ClassroomQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([studentId])
}

model ClassroomAnalytics {
  id              String   @id @default(cuid())
  classroomId     String
  sessionId       String?
  userId          String?
  eventType       String   // JOIN, LEAVE, CHAT, POLL_VOTE, HAND_RAISE, etc.
  eventData       Json?
  timestamp       DateTime @default(now())
  metadata        Json?

  @@index([classroomId])
  @@index([sessionId])
  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
}

