import { cache } from 'react';
import { prisma } from './prisma';
import {
  getLessonsList,
  getSeriesList,
  getForumPostsPaginated,
  getChaptersByLesson,
  getReportsList,
  getUnresolvedReportsCount,
  getEntityImages,
  getEntityVideos,
  getExamsList,
  getSeriesWithExercises,
  getForumPostWithReplies,
} from './queries';

/**
 * React Cache wrappers for database queries
 * These ensure queries are deduplicated within a single request
 * Use these in Server Components for optimal performance
 */

// ============================================
// LESSON CACHE
// ============================================

/**
 * Cache lesson by slug lookup
 * Used in lesson detail pages
 */
export const getCachedLessonBySlug = cache(async (slug: string) => {
  return prisma.lesson.findUnique({
    where: { slug },
    include: {
      module: {
        select: {
          id: true,
          name: true,
          slug: true,
        },
      },
      chapters: {
        where: { status: 'PUBLISHED' },
        select: {
          id: true,
          titleFr: true,
          titleEn: true,
          slug: true,
          chapterNumber: true,
          order: true,
        },
        orderBy: { order: 'asc' },
      },
    },
  });
});

/**
 * Cache lesson list queries
 */
export const getCachedLessonsList = cache(getLessonsList);

/**
 * Cache lesson by ID
 */
export const getCachedLessonById = cache(async (id: string) => {
  return prisma.lesson.findUnique({
    where: { id },
  });
});

// ============================================
// SERIES CACHE
// ============================================

/**
 * Cache series for a lesson
 */
export const getCachedSeriesByLesson = cache(async (lessonId: string) => {
  return getSeriesList({
    lessonId,
    publicOnly: true,
  });
});

/**
 * Cache series by ID with exercises
 */
export const getCachedSeriesWithExercises = cache(getSeriesWithExercises);

/**
 * Cache series by slug
 */
export const getCachedSeriesBySlug = cache(async (slug: string) => {
  return prisma.series.findUnique({
    where: { slug },
    include: {
      exercises: {
        orderBy: { order: 'asc' },
      },
      lesson: {
        select: {
          id: true,
          titleFr: true,
          titleEn: true,
          slug: true,
        },
      },
    },
  });
});

// ============================================
// FORUM CACHE
// ============================================

/**
 * Cache forum posts list
 */
export const getCachedForumPosts = cache(getForumPostsPaginated);

/**
 * Cache forum post with replies
 */
export const getCachedForumPostWithReplies = cache(getForumPostWithReplies);

/**
 * Cache forum post by ID
 */
export const getCachedForumPostById = cache(async (id: string) => {
  return prisma.forumPost.findUnique({
    where: { id },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          image: true,
        },
      },
    },
  });
});

// ============================================
// CHAPTER CACHE
// ============================================

/**
 * Cache chapters for a lesson
 */
export const getCachedChaptersByLesson = cache(getChaptersByLesson);

/**
 * Cache chapter by slug
 */
export const getCachedChapterBySlug = cache(async (slug: string) => {
  return prisma.chapter.findUnique({
    where: { slug },
    include: {
      lesson: {
        select: {
          id: true,
          titleFr: true,
          titleEn: true,
          slug: true,
          level: true,
          stream: true,
          semester: true,
        },
      },
    },
  });
});

// ============================================
// REPORT CACHE
// ============================================

/**
 * Cache reports list
 */
export const getCachedReportsList = cache(getReportsList);

/**
 * Cache unresolved reports count
 */
export const getCachedUnresolvedReportsCount = cache(getUnresolvedReportsCount);

/**
 * Cache report by ID
 */
export const getCachedReportById = cache(async (id: string) => {
  return prisma.report.findUnique({
    where: { id },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          email: true,
        },
      },
      replies: {
        include: {
          repliedBy: {
            select: {
              id: true,
              name: true,
              role: true,
            },
          },
        },
        orderBy: { createdAt: 'asc' },
      },
    },
  });
});

// ============================================
// IMAGE & VIDEO CACHE
// ============================================

/**
 * Cache entity images
 */
export const getCachedEntityImages = cache(getEntityImages);

/**
 * Cache entity videos
 */
export const getCachedEntityVideos = cache(getEntityVideos);

/**
 * Cache image by ID
 */
export const getCachedImageById = cache(async (id: string) => {
  return prisma.platformImage.findUnique({
    where: { id },
  });
});

/**
 * Cache video by ID
 */
export const getCachedVideoById = cache(async (id: string) => {
  return prisma.platformVideo.findUnique({
    where: { id },
  });
});

// ============================================
// EXAM CACHE
// ============================================

/**
 * Cache exams list
 */
export const getCachedExamsList = cache(getExamsList);

/**
 * Cache exam by ID
 */
export const getCachedExamById = cache(async (id: string) => {
  return prisma.exam.findUnique({
    where: { id },
    include: {
      createdBy: {
        select: {
          id: true,
          name: true,
        },
      },
    },
  });
});

// ============================================
// MODULE & STREAM CACHE
// ============================================

/**
 * Cache all modules
 */
export const getCachedModules = cache(async () => {
  return prisma.module.findMany({
    include: {
      educationalStream: {
        select: {
          id: true,
          name: true,
          slug: true,
        },
      },
    },
    orderBy: { order: 'asc' },
  });
});

/**
 * Cache module by slug
 */
export const getCachedModuleBySlug = cache(async (slug: string) => {
  return prisma.module.findUnique({
    where: { slug },
    include: {
      educationalStream: true,
      lessons: {
        where: { status: 'PUBLISHED' },
        select: {
          id: true,
          titleFr: true,
          titleEn: true,
          slug: true,
          level: true,
          stream: true,
          semester: true,
        },
        orderBy: { order: 'asc' },
      },
    },
  });
});

/**
 * Cache educational streams
 */
export const getCachedEducationalStreams = cache(async () => {
  return prisma.educationalStream.findMany({
    include: {
      modules: {
        orderBy: { order: 'asc' },
      },
    },
    orderBy: { name: 'asc' },
  });
});

/**
 * Cache educational stream by slug
 */
export const getCachedEducationalStreamBySlug = cache(async (slug: string) => {
  return prisma.educationalStream.findUnique({
    where: { slug },
    include: {
      modules: {
        orderBy: { order: 'asc' },
      },
    },
  });
});

// ============================================
// USER CACHE
// ============================================

/**
 * Cache user by ID
 */
export const getCachedUserById = cache(async (id: string) => {
  return prisma.user.findUnique({
    where: { id },
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      role: true,
      preferredLang: true,
      createdAt: true,
    },
  });
});

/**
 * Cache user by email
 */
export const getCachedUserByEmail = cache(async (email: string) => {
  return prisma.user.findUnique({
    where: { email },
    select: {
      id: true,
      name: true,
      email: true,
      image: true,
      role: true,
      preferredLang: true,
    },
  });
});

// ============================================
// ANNOUNCEMENT CACHE
// ============================================

/**
 * Cache active announcements
 */
export const getCachedActiveAnnouncements = cache(async () => {
  return prisma.announcement.findMany({
    where: { isActive: true },
    orderBy: { createdAt: 'desc' },
  });
});
